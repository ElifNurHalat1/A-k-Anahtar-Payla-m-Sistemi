

//gerekli kütüphanler ve linkleri

#include <ESP8266WiFi.h>//esp kartta mevcut yüklemeye gerek yok
#include <espnow.h>//esp kartta mevcut yüklemeye gerek yok
#include <LiquidCrystal_I2C.h>

#include <Wire.h>//esp kartta mevcut yüklemeye gerek yok

String sifreListe[1000]={"8823" ,"2252" ,"7032" ,"2001" ,"7047" ,"6893" ,"1671" ,"1514" ,"3290" ,"2296" ,"1665" ,"5373" ,"6457" ,"1630" ,"8826" ,"5312" ,"8990" ,"0084" ,"0759" ,"2487" ,"9346" ,"9426" ,"9914" ,"0317" ,"5466" ,"4626" ,"6174" ,"0384" ,"0471" ,"9433" ,"6211" ,"8447" ,"5847" ,"7232" ,"0707" ,"7765" ,"1735" ,"5080" ,"1391" ,"5182" ,"6992" ,"8067" ,"1401" ,"4568" ,"6591" ,"0815" ,"9464" ,"2169" ,"9817" ,"8361" ,"0540" ,"9656" ,"6150" ,"2628" ,"8424" ,"4259" ,"8126" ,"4892" ,"8814" ,"4053" ,"8071" ,"6662" ,"6294" ,"1267" ,"0528" ,"3918" ,"1214" ,"5748" ,"8864" ,"4321" ,"4901" ,"9516" ,"1338" ,"7798" ,"8904" ,"4278" ,"8152" ,"5226" ,"3134" ,"9085" ,"1521" ,"3500" ,"8865" ,"3861" ,"2128" ,"9808" ,"1656" ,"3597" ,"0439" ,"0643" ,"0437" ,"6634" ,"4217" ,"8062" ,"4407" ,"9372" ,"8858" ,"4716" ,"7874" ,"5314" ,"3021" ,"4189" ,"8045" ,"5737" ,"7087" ,"1407" ,"0599" ,"3161" ,"2549" ,"1587" ,"0504" ,"2500" ,"5064" ,"4328" ,"0408" ,"1866" ,"3330" ,"3451" ,"1176" ,"4555" ,"5943" ,"4278" ,"3586" ,"5051" ,"8309" ,"2060" ,"4433" ,"5544" ,"9521" ,"3221" ,"5467" ,"5961" ,"5670" ,"5525" ,"2499" ,"8327" ,"1369" ,"7376" ,"1838" ,"3945" ,"8279" ,"7394" ,"3789" ,"3231" ,"1862" ,"2732" ,"9186" ,"2313" ,"9316" ,"6307" ,"4260" ,"4729" ,"5175" ,"3220" ,"8505" ,"5219" ,"6590" ,"0657" ,"8870" ,"1371" ,"9910" ,"6607" ,"1070" ,"3422" ,"0739" ,"8289" ,"6964" ,"5295" ,"8965" ,"0129" ,"4289" ,"8444" ,"5493" ,"9737" ,"1246" ,"9528" ,"1223" ,"7719" ,"4456" ,"3801" ,"5290" ,"2560" ,"6948" ,"6608" ,"9986" ,"1068" ,"2095" ,"2632" ,"2216" ,"6165" ,"6278" ,"2327" ,"4663" ,"9394" ,"6172" ,"5189" ,"5163" ,"5328" ,"3209" ,"2759" ,"7205" ,"0028" ,"2604" ,"3394" ,"3830" ,"6920" ,"4807" ,"2018" ,"5853" ,"0284" ,"9708" ,"2749" ,"2554" ,"3427" ,"9912" ,"0562" ,"5195" ,"8641" ,"0819" ,"8486" ,"4046" ,"4741" ,"5740" ,"0643" ,"1831" ,"8916" ,"1335" ,"3395" ,"1479" ,"1977" ,"6791" ,"1413" ,"4779" ,"1784" ,"9750" ,"3981" ,"7985" ,"8421" ,"0540" ,"9946" ,"2015" ,"6034" ,"6303" ,"4737" ,"9832" ,"5549" ,"5595" ,"2859" ,"2883" ,"8257" ,"5495" ,"3873" ,"1700" ,"6116" ,"5190" ,"0818" ,"7105" ,"9087" ,"3671" ,"6957" ,"7535" ,"7531" ,"7177" ,"3466" ,"2182" ,"7241" ,"8379" ,"3006" ,"5225" ,"4501" ,"7988" ,"2148" ,"9185" ,"0395" ,"1274" ,"7377" ,"0010" ,"1127" ,"0657" ,"4687" ,"9802" ,"1562" ,"3731" ,"8633" ,"2071" ,"9368" ,"8143" ,"7105" ,"4048" ,"3455" ,"4974" ,"7084" ,"2153" ,"8675" ,"2140" ,"0241" ,"6878" ,"1507" ,"5279" ,"6208" ,"2006" ,"5777" ,"2861" ,"0542" ,"5579" ,"2027" ,"0785" ,"9890" ,"1570" ,"1759" ,"1052" ,"8879" ,"8540" ,"4162" ,"7258" ,"8184" ,"8604" ,"7307" ,"0881" ,"4091" ,"9874" ,"4950" ,"9539" ,"2709" ,"2142" ,"8314" ,"4696" ,"2477" ,"3380" ,"3308" ,"1942" ,"0152" ,"7893" ,"5736" ,"6397" ,"9875" ,"8658" ,"9068" ,"1508" ,"8943" ,"1694" ,"4316" ,"0139" ,"4282" ,"2943" ,"5636" ,"1010" ,"6487" ,"9663" ,"9204" ,"5987" ,"7648" ,"6869" ,"5084" ,"3334" ,"1096" ,"3508" ,"6530" ,"8085" ,"8685" ,"6347" ,"8828" ,"7196" ,"9624" ,"9131" ,"5620" ,"5504" ,"1257" ,"4878" ,"5184" ,"3104" ,"6712" ,"7466" ,"2699" ,"0422" ,"7775" ,"6211" ,"8388" ,"3983" ,"6838" ,"4867" ,"6857" ,"8881" ,"9576" ,"4483" ,"5934" ,"5733" ,"8532" ,"0489" ,"0097" ,"7420" ,"5797" ,"2291" ,"0024" ,"4218" ,"5183" ,"4604" ,"7754" ,"4061" ,"7397" ,"8516" ,"5210" ,"1357" ,"8115" ,"5969" ,"7404" ,"6579" ,"4170" ,"3499" ,"0272" ,"4923" ,"2752" ,"9068" ,"7004" ,"5690" ,"4260" ,"6444" ,"2142" ,"1447" ,"1629" ,"9493" ,"4933" ,"3544" ,"3671" ,"3278" ,"2007" ,"5363" ,"5228" ,"4009" ,"2257" ,"0106" ,"7094" ,"6339" ,"8369" ,"4280" ,"2081" ,"3592" ,"6891" ,"6071" ,"0304" ,"4271" ,"9200" ,"4150" ,"4550" ,"3931" ,"1688" ,"4238" ,"5490" ,"1360" ,"3620" ,"5884" ,"2861" ,"5780" ,"0938" ,"3876" ,"9149" ,"2481" ,"9476" ,"7362" ,"7455" ,"6128" ,"6892" ,"9764" ,"8503" ,"4918" ,"9520" ,"9127" ,"3109" ,"3207" ,"9634" ,"4611" ,"8371" ,"2278" ,"2751" ,"9284" ,"5287" ,"7716" ,"5248" ,"6732" ,"3026" ,"3150" ,"3176" ,"6986" ,"7882" ,"7431" ,"1169" ,"8924" ,"3278" ,"0204" ,"7846" ,"9406" ,"4707" ,"9149" ,"7142" ,"4523" ,"8323" ,"1965" ,"8459" ,"9716" ,"0050" ,"8542" ,"7818" ,"7701" ,"5076" ,"2654" ,"1595" ,"5590" ,"9724" ,"9243" ,"8052" ,"8770" ,"3349" ,"0543" ,"5082" ,"5962" ,"9199" ,"5523" ,"5371" ,"0263" ,"8812" ,"1994" ,"3898" ,"3188" ,"4337" ,"8858" ,"0046" ,"7322" ,"4446" ,"8319" ,"1466" ,"6303" ,"5967" ,"8959" ,"3310" ,"5279" ,"5648" ,"7101" ,"1453" ,"2817" ,"9017" ,"6544" ,"9535" ,"1038" ,"7610" ,"9264" ,"8564" ,"3275" ,"2405" ,"1930" ,"1981" ,"8590" ,"1766" ,"6087" ,"4780" ,"9906" ,"7737" ,"0767" ,"2189" ,"3453" ,"6536" ,"6181" ,"6314" ,"0212" ,"9240" ,"2203" ,"0835" ,"1949" ,"1543" ,"6406" ,"9106" ,"6279" ,"9691" ,"0514" ,"4068" ,"7297" ,"8125" ,"8754" ,"1710" ,"1467" ,"0454" ,"9396" ,"4996" ,"8296" ,"1385" ,"0202" ,"1592" ,"3020" ,"3873" ,"7585" ,"1618" ,"7869" ,"8598" ,"5078" ,"3333" ,"3723" ,"7929" ,"5696" ,"4243" ,"1152" ,"8048" ,"0443" ,"1893" ,"1424" ,"4717" ,"5631" ,"6333" ,"6371" ,"8052" ,"2322" ,"5986" ,"6540" ,"0993" ,"0761" ,"6227" ,"0167" ,"1851" ,"9920" ,"4826" ,"8751" ,"8326" ,"4310" ,"3359" ,"1424" ,"3148" ,"9300" ,"7891" ,"4038" ,"7197" ,"8027" ,"6475" ,"3299" ,"6826" ,"3715" ,"2186" ,"4963" ,"9620" ,"5453" ,"9614" ,"6575" ,"8955" ,"7759" ,"9356" ,"1527" ,"8356" ,"0931" ,"3976" ,"6697" ,"4375" ,"4052" ,"1202" ,"9823" ,"3362" ,"9049" ,"5328" ,"9932" ,"4727" ,"8727" ,"8258" ,"8114" ,"7322" ,"0673" ,"9791" ,"7731" ,"8871" ,"6456" ,"1846" ,"5614" ,"1805" ,"7127" ,"0870" ,"7100" ,"9390" ,"3982" ,"8501" ,"2082" ,"6598" ,"7747" ,"5917" ,"6480" ,"8371" ,"7102" ,"0761" ,"0059" ,"0432" ,"2132" ,"9144" ,"8064" ,"7038" ,"3655" ,"5789" ,"0274" ,"4161" ,"1676" ,"0425" ,"6539" ,"1249" ,"7654" ,"9864" ,"3316" ,"3906" ,"4431" ,"2689" ,"4089" ,"3887" ,"8877" ,"6222" ,"9336" ,"2516" ,"5756" ,"9360" ,"7608" ,"9714" ,"4485" ,"2201" ,"1019" ,"3268" ,"8236" ,"2275" ,"2799" ,"2431" ,"1818" ,"7643" ,"7359" ,"1675" ,"0197" ,"3512" ,"6235" ,"2097" ,"6074" ,"0702" ,"7089" ,"6835" ,"9490" ,"4676" ,"6924" ,"3906" ,"3821" ,"8242" ,"0793" ,"6267" ,"8758" ,"1920" ,"2171" ,"5688" ,"0158" ,"5277" ,"9606" ,"6494" ,"3466" ,"3154" ,"5197" ,"4374" ,"8135" ,"6726" ,"0784" ,"8647" ,"1371" ,"9248" ,"5024" ,"3025" ,"9585" ,"1475" ,"2966" ,"3169" ,"7151" ,"6545" ,"6496" ,"5730" ,"4252" ,"7866" ,"5280" ,"6844" ,"4361" ,"4193" ,"1296" ,"5104" ,"6510" ,"5318" ,"4854" ,"7487" ,"9411" ,"1153" ,"3115" ,"9014" ,"1430" ,"7481" ,"1875" ,"6566" ,"3160" ,"9835" ,"0774" ,"2584" ,"7022" ,"1805" ,"5003" ,"3977" ,"5428" ,"3052" ,"1709" ,"7495" ,"9385" ,"2355" ,"0059" ,"8010" ,"0997" ,"3006" ,"5913" ,"7081" ,"1430" ,"1141" ,"8783" ,"5641" ,"5098" ,"4129" ,"2103" ,"2279" ,"2474" ,"6188" ,"4796" ,"2719" ,"5077" ,"1069" ,"1479" ,"1196" ,"9801" ,"8944" ,"1137" ,"2675" ,"0071" ,"4082" ,"8721" ,"3862" ,"8263" ,"6006" ,"5260" ,"6975" ,"7291" ,"4719" ,"0720" ,"6312" ,"4189" ,"9390" ,"0161" ,"4869" ,"0741" ,"9580" ,"0738" ,"7092" ,"1355" ,"0753" ,"2913" ,"1952" ,"1308" ,"8029" ,"3882" ,"0029" ,"1400" ,"2082" ,"1080" ,"4491" ,"1163" ,"0131" ,"0611" ,"8332" ,"6126" ,"9490" ,"5778" ,"1258" ,"8708" ,"3990" ,"1996" ,"9647" ,"6532" ,"2217" ,"1583" ,"3498" ,"0331" ,"3487" ,"1250" ,"5218" ,"2915" ,"8256" ,"6377" ,"0666" ,"9155" ,"3342" ,"6610" ,"6128" ,"4004" ,"3398" ,"7649" ,"7165" ,"5903" ,"6649" ,"4982" ,"1495" ,"1830" ,"6225" ,"1776" ,"8545" ,"9557" ,"0818" ,"5093" ,"4663" ,"7989" ,"7693" ,"6419" ,"8719" ,"4335" ,"9143" ,"6545" ,"3915" ,"0498" ,"6582" ,"6215" ,"6298" ,"9981" ,"2135" ,"4522" ,"1407" ,"3683" ,"8239" ,"5197" ,"0963" ,"5653" ,"0929" ,"1331" ,"2512" ,"2410" ,"3696" ,"6961" ,"1555" ,"8864" ,"8663" ,"3924" ,"8179" ,"9755" ,"8609" ,"7971" ,"3075" ,"7823" ,"9635" ,"7764" ,"4474" ,"1614" ,"9972" ,"8678" ,"9592" ,"1670" ,"8393" ,"3080" ,"9652" ,"1296" ,"8357" ,"1942" ,"8461" ,"8327" ,"7768" ,"7809" ,"1632" ,"1576" ,"6338" ,"0989" ,"8748" ,"3615" ,"3743" ,"6090" ,"2564" ,"6203" ,"7945" ,"9478" ,"9699" ,"3164" ,"4784" ,"0305" ,"3354" ,"3326" ,"6114" ,"2659" ,"0649" ,"1061" ,"9198" ,"3623" ,"8816" ,"8355" ,"4222" ,"0228" ,"1844" ,"8142" ,"6441" ,"4329" ,"8753" ,"4917" ,"0948" ,"7407" ,"9174" ,"2757" ,"4894" ,"8311" ,"0333" };
String letters[10] = {"1", "2", "3", "4", "5", "6", "7", "8", "9", "0"};
String randString = "";
int randSayi;
boolean bulundu;



LiquidCrystal_I2C lcd(0x27,16,2); 

//diğer kartın mac adresini girin 
uint8_t alici_macadresi[] = {0xE8, 0xDB, 0x84, 0xE1, 0xB7, 0x84}; 

String mesaj;

//gerekli diğer değişkenler
bool alinanistekmesaji=false;
String  gelenmesaj;
bool gelencevap;
bool istekiletildi=1;
const long bekleme = 5000; 
unsigned long oncekiMillis = 0;  

// Alıncak ve gönderilecek veri yapısı için structure tanımlama
// Diğer kartlar ile aynı yapı olmalı
typedef struct struct_message {
    String text; 
    bool istekgonder;
    bool cevap;
} struct_message;

// veri göndermek için yarattığımız veri yapısı
struct_message veriler;

// gelen verileri almak için yarattığımız veri yapısı
struct_message gelenveriler;

// Veriler gönderildiğinde çalıştıracağımız fonksiyon
void VerilerGonderildiginde(uint8_t *mac_addr, uint8_t sendStatus) {
  Serial.print("Son verinin gonderilme durumu: ");
  if (sendStatus == 0){
    Serial.println("Veri Gonderme Başarılı");
    istekiletildi=1;
  }
  else{
    Serial.println("Veriler Gönderilmedi!!!");
    istekiletildi=0;
  }
}

// Veriler alındığında çalışacak fonksiyon
void VerilerAlindiginda(uint8_t * mac, uint8_t *incomingData, uint8_t len) {
  memcpy(&gelenveriler, incomingData, sizeof(gelenveriler));
  Serial.print("Alınan veri boyutu: ");
  Serial.println(len);
  alinanistekmesaji = gelenveriler.istekgonder;//diğer karttan istek gelmiş mi bakıyoruz
  gelenmesaj= gelenveriler.text;
  gelencevap = gelenveriler.cevap;
}


void gelenverileriyazdir(){
  // diğer karttan istek gelip gelmediği bilgisini serial ekrana yazdır
 
  Serial.println(" Gelen mesaj: ");
  Serial.println(alinanistekmesaji);
  Serial.println("GELEN DEGERLER:");
  Serial.print("Gelen Cevap: ");
  Serial.print(gelencevap);
  Serial.print("Gelen mesaj: ");
  Serial.print(gelenmesaj);

}
 
void setup() {
  
  Serial.begin(115200);

  
 
  // Cihazı station olarak tanımlayıp bağlıysa ağlardan çıkıyoruz
  WiFi.mode(WIFI_STA);
  WiFi.disconnect();

  // ESP-NOW'u başlatıyoruz
  if (esp_now_init() != 0) {
    Serial.println("ESP-NOW Başlatılamadı !!!");
    return;
  }

  // Bu kartın rolünü tanımlıyoruz. Çift yönlü iletişimde kartlar COMBO olmalı
  esp_now_set_self_role(ESP_NOW_ROLE_COMBO);

  // Yukarıda tanımladığımız ve veri gönderildiğinde çalışacak fonksiyonu atıyoruz
  esp_now_register_send_cb(VerilerGonderildiginde);
  
  // Bağlanılacak diğer karta bağlantıyı tanımlıyoruz
  esp_now_add_peer(alici_macadresi, ESP_NOW_ROLE_COMBO, 1, NULL, 0);
  
  // Yukarıda tanımladığımız ve veri alındığında çalışacak fonksiyonu atıyoruz
  esp_now_register_recv_cb(VerilerAlindiginda);

  lcd.begin();
  lcd.backlight();
  lcd.setBacklight(HIGH);
  lcd.setCursor(0,0);
  lcd.print("Sistem ");
  lcd.setCursor(0,1);
  lcd.print("Baslatiliyor");
  delay(500);
  

}
 
void loop() {

  veriler.istekgonder = 1;//alıcıya istekgonder değişkenini 1 yapıp gönderiyoruz
   esp_now_send(alici_macadresi, (uint8_t *) &veriler, sizeof(veriler));
   
  
  delay(200);

  if (alinanistekmesaji) {

      for(int i=0;i<4;i++)
        {
          randSayi=random(10);
          randString+=letters[randSayi];
          
          }
          

    mesaj=randString;
    veriler.text = mesaj;
    veriler.cevap=1;
    esp_now_send(alici_macadresi, (uint8_t *) &veriler, sizeof(veriler)); 
    randString="";
      delay(200);   
    alinanistekmesaji=false; 
  }
  oncekiMillis=millis();

  
    if (gelencevap==true){

 
    unsigned long simdikiMillis = millis();//sayacı başlattık
    //bekleme süresi kadar zaman geçmişse 
    if (simdikiMillis - oncekiMillis >= bekleme) { 
      gelencevap=false;//artık gelen cevap değişkenini tekrar sıfırla çünkü gösterdik işimiz bitti
      oncekiMillis = simdikiMillis;//sayacı tekrar sıfırladık
    }

  //gelen verileri serial monitöre yazdır
       gelenverileriyazdir();
      lcd.setCursor(0,0);
      lcd.print("Gelen deger "+ gelenmesaj);
        
     lcd.setCursor(0,1);
      
     for (int k=0;k<1000;k++)
     {
       if(letters[k]==gelenmesaj)
       {
        bulundu=1;
        break;
        }
      }
      
     if(bulundu)
     {
      lcd.print("Listede var ");
      }
      else
      {
        lcd.print("Listede yok ");
        
      }

      bulundu=0;
      
      // gelenmesajı yazdır
     
    
  }
}
